<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025ä¸­ç§‹çƒ¤è‚‰ç°½åˆ°ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFPtv-eValmarH9g96Ef-OdbwdYger6tE",
            authDomain: "x-tw-455de.firebaseapp.com",
            projectId: "x-tw-455de",
            storageBucket: "x-tw-455de.firebasestorage.app",
            messagingSenderId: "843984136113",
            appId: "1:843984136113:web:209b33f8d74ee3f2813f90",
            measurementId: "G-H3FYWYZKQZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // å°‡Firebaseå¯¦ä¾‹æš´éœ²åˆ°å…¨åŸŸ
        window.firebaseDB = db;
        window.firestoreDoc = doc;
        window.firestoreSetDoc = setDoc;
        window.firestoreGetDoc = getDoc;
        window.firestoreOnSnapshot = onSnapshot;
    </script>
    <style>
        body {
            box-sizing: border-box;
        }
        .gradient-bg {
            background: #ffffff;
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .barcode-scanner {
            border: 2px dashed #4f46e5;
            background: rgba(79, 70, 229, 0.05);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸŒ• 2025ä¸­ç§‹çƒ¤è‚‰</h1>
            <p class="text-xl text-gray-600">ç°½åˆ°é ˜è´ˆå“ç³»çµ±</p>
        </div>

        <!-- ç°½åˆ°å€åŸŸ -->
        <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">ğŸ‘¥ ç°½åˆ°åå–®</h2>
            
            <!-- å¤§äººåå–® -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                    ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å¤§äºº (é’èŒ¶ x2ï¼Œéœ€åˆ·æµæ°´è™Ÿ)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="adultList">
                    <!-- å¤§äººåå–®å°‡ç”±JavaScriptç”Ÿæˆ -->
                </div>
            </div>

            <!-- å°å­©åå–® -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                    ğŸ‘¶ å°å­© (é¤…ä¹¾ x2ï¼Œå•†å“æ¢ç¢¼ï¼š2025-PROD-COOK-4515)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="childList">
                    <!-- å°å­©åå–®å°‡ç”±JavaScriptç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- æ¢ç¢¼æƒæå€åŸŸ -->
        <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">ğŸ“± æ¢ç¢¼æƒææ ¸éŠ·</h2>
            <div class="barcode-scanner rounded-lg p-6 text-center">
                <div class="mb-4">
                    <svg class="w-16 h-16 mx-auto text-indigo-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h2M4 4h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2z"></path>
                    </svg>
                    <p class="text-gray-600">æƒææµæ°´è™Ÿæ¢ç¢¼é€²è¡Œç°½åˆ°æˆ–é ˜å–è´ˆå“</p>
                    <p class="text-sm text-gray-500 mt-1">å¤§äººï¼šåˆ·æµæ°´è™Ÿç°½åˆ°ï¼Œå†åˆ·ä¸€æ¬¡é ˜é’èŒ¶ | å°å­©ï¼šåˆ·æµæ°´è™Ÿç°½åˆ°ï¼Œå†åˆ·å•†å“æ¢ç¢¼2025-PROD-COOK-4515é ˜é¤…ä¹¾</p>
                </div>
                <input type="text" id="barcodeInput" placeholder="è¼¸å…¥æ¢ç¢¼ (å¦‚ï¼š2025-0001-DING-LIWEN) æˆ–å•†å“æ¢ç¢¼ 2025-PROD-COOK-4515" 
                       class="w-full max-w-md mx-auto px-4 py-3 border-2 border-gray-300 rounded-lg text-center text-lg focus:border-indigo-500 focus:outline-none">
                <button onclick="scanBarcode()" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    ğŸ” æƒææ ¸éŠ·
                </button>
            </div>
        </div>

        <!-- çµ±è¨ˆè³‡è¨Š -->
        <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">ğŸ“Š çµ±è¨ˆè³‡è¨Š</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" id="checkedInCount">0</div>
                    <div class="text-sm text-gray-600">å·²ç°½åˆ°</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600" id="teaRedeemed">0</div>
                    <div class="text-sm text-gray-600">é’èŒ¶å·²é ˜</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-orange-600" id="cookieRedeemed">0</div>
                    <div class="text-sm text-gray-600">é¤…ä¹¾å·²é ˜</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600" id="totalPeople">9</div>
                    <div class="text-sm text-gray-600">ç¸½äººæ•¸</div>
                </div>
            </div>
        </div>

        <!-- Firebase æ¸¬è©¦å€åŸŸ -->
        <div class="bg-white rounded-2xl card-shadow p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">â˜ï¸ Firebase é›²ç«¯ç‹€æ…‹</h2>
            <div class="text-center">
                <div id="firebaseStatus" class="mb-4 p-4 rounded-lg bg-gray-100">
                    <div class="text-lg font-semibold text-gray-700">é€£ç·šç‹€æ…‹ï¼šæª¢æŸ¥ä¸­...</div>
                    <div class="text-sm text-gray-500 mt-1">æ­£åœ¨æ¸¬è©¦Firebaseé€£ç·š</div>
                </div>
                <button onclick="testFirebase()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    ğŸ§ª æ¸¬è©¦Firebaseé€£ç·š
                </button>
                <button onclick="viewFirebaseData()" class="ml-4 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    ğŸ‘ï¸ æŸ¥çœ‹é›²ç«¯è³‡æ–™
                </button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥å½ˆçª— -->
    <div id="notification" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300">
        <span id="notificationText"></span>
    </div>

    <script>
        // äººå“¡è³‡æ–™ - æ¯å€‹äººéƒ½æœ‰å°ˆå±¬æ¢ç¢¼
        const people = {
            adults: [
                { name: 'ä¸ç«‹æ–‡', barcode: '2025-0001-DING-LIWEN', checkedIn: false, teaCount: 0, maxTea: 2 },
                { name: 'ä¸ç¶­å¾·', barcode: '2025-0002-DING-WEIDE', checkedIn: false, teaCount: 0, maxTea: 2 },
                { name: 'ä¸ç¶­æ³°', barcode: '2025-0003-DING-WEITAI', checkedIn: false, teaCount: 0, maxTea: 2 },
                { name: 'åŠ‰ä½³ç¦', barcode: '2025-0004-LIU-JIAZHEN', checkedIn: false, teaCount: 0, maxTea: 2 },
                { name: 'åŠ‰ç•°æ›²', barcode: '2025-0005-LIU-YIQU', checkedIn: false, teaCount: 0, maxTea: 2 },
                { name: 'ä¸ç¶­å»‰', barcode: '2025-0006-DING-WEILIAN', checkedIn: false, teaCount: 0, maxTea: 2 },
                { name: 'å½­æ›‰ç', barcode: '2025-0007-PENG-XIAOZHEN', checkedIn: false, teaCount: 0, maxTea: 2 }
            ],
            children: [
                { name: 'ä¸ç¿Šè²', barcode: '2025-0471-DING-YIFEI', checkedIn: false, cookieCount: 0, maxCookie: 2 },
                { name: 'ä¸ç¿Šåº­', barcode: '2025-0472-DING-YITING', checkedIn: false, cookieCount: 0, maxCookie: 2 }
            ]
        };

        // Firebase è³‡æ–™æ“ä½œ - ä½¿ç”¨æœ¬åœ°å„²å­˜ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ
        async function saveDataToFirebase() {
            try {
                // å…ˆå˜—è©¦Firebase
                const docRef = window.firestoreDoc(window.firebaseDB, "events", "mid-autumn-2025");
                await window.firestoreSetDoc(docRef, { 
                    people: people,
                    lastUpdated: new Date().toISOString(),
                    updateCount: (await getUpdateCount()) + 1
                }, { merge: true });
                console.log("è³‡æ–™å·²å„²å­˜åˆ°é›²ç«¯");
                updateFirebaseStatus("âœ… è³‡æ–™å·²æˆåŠŸå„²å­˜åˆ°é›²ç«¯", "success");
                
                // åŒæ™‚å„²å­˜åˆ°æœ¬åœ°
                localStorage.setItem('mid-autumn-2025-data', JSON.stringify({
                    people: people,
                    lastUpdated: new Date().toISOString()
                }));
            } catch (error) {
                console.error("Firebaseå„²å­˜å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜:", error);
                // Firebaseå¤±æ•—æ™‚ä½¿ç”¨æœ¬åœ°å„²å­˜
                localStorage.setItem('mid-autumn-2025-data', JSON.stringify({
                    people: people,
                    lastUpdated: new Date().toISOString()
                }));
                updateFirebaseStatus("âš ï¸ é›²ç«¯å„²å­˜å¤±æ•—ï¼Œå·²æ”¹ç”¨æœ¬åœ°å„²å­˜", "warning");
            }
        }

        // ç²å–æ›´æ–°æ¬¡æ•¸
        async function getUpdateCount() {
            try {
                const docRef = window.firestoreDoc(window.firebaseDB, "events", "mid-autumn-2025");
                const docSnap = await window.firestoreGetDoc(docRef);
                return docSnap.exists() ? (docSnap.data().updateCount || 0) : 0;
            } catch (error) {
                return 0;
            }
        }

        // æ¸¬è©¦Firebaseé€£ç·š
        async function testFirebase() {
            updateFirebaseStatus("ğŸ”„ æ­£åœ¨æ¸¬è©¦Firebaseé€£ç·š...", "loading");
            
            try {
                // æ¸¬è©¦å¯«å…¥
                const testDoc = window.firestoreDoc(window.firebaseDB, "test", "connection");
                await window.firestoreSetDoc(testDoc, {
                    timestamp: new Date().toISOString(),
                    test: "Firebaseé€£ç·šæ¸¬è©¦æˆåŠŸ"
                });
                
                // æ¸¬è©¦è®€å–
                const docSnap = await window.firestoreGetDoc(testDoc);
                if (docSnap.exists()) {
                    updateFirebaseStatus("âœ… Firebaseé€£ç·šæ­£å¸¸ï¼è³‡æ–™å¯ä»¥æ­£å¸¸è®€å¯«", "success");
                } else {
                    updateFirebaseStatus("âš ï¸ å¯«å…¥æˆåŠŸä½†è®€å–å¤±æ•—", "warning");
                }
            } catch (error) {
                updateFirebaseStatus("âŒ Firebaseæ¬Šé™ä¸è¶³ï¼Œå·²å•Ÿç”¨æœ¬åœ°å„²å­˜æ¨¡å¼", "error");
                console.log("FirebaseéŒ¯èª¤è©³æƒ…:", error);
                
                // æ¸¬è©¦æœ¬åœ°å„²å­˜
                try {
                    const testData = { test: "æœ¬åœ°å„²å­˜æ¸¬è©¦", timestamp: new Date().toISOString() };
                    localStorage.setItem('test-storage', JSON.stringify(testData));
                    const retrieved = localStorage.getItem('test-storage');
                    if (retrieved) {
                        updateFirebaseStatus("ğŸ“± æœ¬åœ°å„²å­˜åŠŸèƒ½æ­£å¸¸ï¼Œè³‡æ–™æœƒä¿å­˜åœ¨ç€è¦½å™¨ä¸­", "warning");
                    }
                } catch (localError) {
                    updateFirebaseStatus("âŒ æœ¬åœ°å„²å­˜ä¹Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š", "error");
                }
            }
        }

        // æŸ¥çœ‹è³‡æ–™
        async function viewFirebaseData() {
            let info = "";
            
            // å˜—è©¦è®€å–Firebaseè³‡æ–™
            try {
                const docRef = window.firestoreDoc(window.firebaseDB, "events", "mid-autumn-2025");
                const docSnap = await window.firestoreGetDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    info += `â˜ï¸ é›²ç«¯è³‡æ–™ç‹€æ…‹ï¼š
â€¢ æœ€å¾Œæ›´æ–°ï¼š${data.lastUpdated || 'æœªçŸ¥'}
â€¢ æ›´æ–°æ¬¡æ•¸ï¼š${data.updateCount || 0}
â€¢ å¤§äººè³‡æ–™ï¼š${data.people?.adults?.length || 0} ç­†
â€¢ å°å­©è³‡æ–™ï¼š${data.people?.children?.length || 0} ç­†

`;
                } else {
                    info += "â˜ï¸ é›²ç«¯å°šç„¡è³‡æ–™\n\n";
                }
            } catch (error) {
                info += `â˜ï¸ é›²ç«¯è®€å–å¤±æ•—: ${error.message}\n\n`;
            }
            
            // è®€å–æœ¬åœ°è³‡æ–™
            try {
                const localData = localStorage.getItem('mid-autumn-2025-data');
                if (localData) {
                    const data = JSON.parse(localData);
                    info += `ğŸ“± æœ¬åœ°è³‡æ–™ç‹€æ…‹ï¼š
â€¢ æœ€å¾Œæ›´æ–°ï¼š${data.lastUpdated || 'æœªçŸ¥'}
â€¢ å¤§äººè³‡æ–™ï¼š${data.people?.adults?.length || 0} ç­†
â€¢ å°å­©è³‡æ–™ï¼š${data.people?.children?.length || 0} ç­†
â€¢ å„²å­˜å¤§å°ï¼š${(JSON.stringify(data).length / 1024).toFixed(2)} KB`;
                } else {
                    info += "ğŸ“± æœ¬åœ°å°šç„¡è³‡æ–™";
                }
            } catch (error) {
                info += `ğŸ“± æœ¬åœ°è®€å–å¤±æ•—: ${error.message}`;
            }
            
            alert(info);
        }

        // æ›´æ–°Firebaseç‹€æ…‹é¡¯ç¤º
        function updateFirebaseStatus(message, type) {
            const statusDiv = document.getElementById('firebaseStatus');
            let bgColor = 'bg-gray-100';
            let textColor = 'text-gray-700';
            
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-700';
                    break;
                case 'error':
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-700';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-100';
                    textColor = 'text-yellow-700';
                    break;
                case 'loading':
                    bgColor = 'bg-blue-100';
                    textColor = 'text-blue-700';
                    break;
            }
            
            statusDiv.innerHTML = `
                <div class="text-lg font-semibold ${textColor}">${message}</div>
                <div class="text-sm text-gray-500 mt-1">æ™‚é–“ï¼š${new Date().toLocaleString()}</div>
            `;
            statusDiv.className = `mb-4 p-4 rounded-lg ${bgColor}`;
        }

        async function loadDataFromFirebase() {
            try {
                // å…ˆå˜—è©¦å¾Firebaseè¼‰å…¥
                const docRef = window.firestoreDoc(window.firebaseDB, "events", "mid-autumn-2025");
                const docSnap = await window.firestoreGetDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.people) {
                        // åˆä½µé›²ç«¯è³‡æ–™ï¼Œä¿æŒæ¢ç¢¼ä¸è®Š
                        data.people.adults.forEach((cloudPerson, index) => {
                            if (people.adults[index]) {
                                people.adults[index].checkedIn = cloudPerson.checkedIn;
                                people.adults[index].teaCount = cloudPerson.teaCount;
                            }
                        });
                        data.people.children.forEach((cloudPerson, index) => {
                            if (people.children[index]) {
                                people.children[index].checkedIn = cloudPerson.checkedIn;
                                people.children[index].cookieCount = cloudPerson.cookieCount;
                            }
                        });
                        console.log("é›²ç«¯è³‡æ–™è¼‰å…¥æˆåŠŸ");
                        return;
                    }
                }
            } catch (error) {
                console.error("Firebaseè¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦æœ¬åœ°å„²å­˜:", error);
            }
            
            // Firebaseå¤±æ•—æ™‚å˜—è©¦æœ¬åœ°å„²å­˜
            try {
                const localData = localStorage.getItem('mid-autumn-2025-data');
                if (localData) {
                    const data = JSON.parse(localData);
                    if (data.people) {
                        data.people.adults.forEach((localPerson, index) => {
                            if (people.adults[index]) {
                                people.adults[index].checkedIn = localPerson.checkedIn;
                                people.adults[index].teaCount = localPerson.teaCount;
                            }
                        });
                        data.people.children.forEach((localPerson, index) => {
                            if (people.children[index]) {
                                people.children[index].checkedIn = localPerson.checkedIn;
                                people.children[index].cookieCount = localPerson.cookieCount;
                            }
                        });
                        console.log("æœ¬åœ°è³‡æ–™è¼‰å…¥æˆåŠŸ");
                        updateFirebaseStatus("ğŸ“± å·²è¼‰å…¥æœ¬åœ°å„²å­˜çš„è³‡æ–™", "warning");
                    }
                }
            } catch (error) {
                console.error("æœ¬åœ°å„²å­˜è¼‰å…¥å¤±æ•—:", error);
            }
        }

        // å³æ™‚åŒæ­¥ç›£è½
        function setupRealtimeSync() {
            const docRef = window.firestoreDoc(window.firebaseDB, "events", "mid-autumn-2025");
            window.firestoreOnSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    if (data.people) {
                        // æ›´æ–°æœ¬åœ°è³‡æ–™
                        data.people.adults.forEach((cloudPerson, index) => {
                            if (people.adults[index]) {
                                people.adults[index].checkedIn = cloudPerson.checkedIn;
                                people.adults[index].teaCount = cloudPerson.teaCount;
                            }
                        });
                        data.people.children.forEach((cloudPerson, index) => {
                            if (people.children[index]) {
                                people.children[index].checkedIn = cloudPerson.checkedIn;
                                people.children[index].cookieCount = cloudPerson.cookieCount;
                            }
                        });
                        // é‡æ–°æ¸²æŸ“é é¢
                        renderAdultList();
                        renderChildList();
                        updateStatistics();
                    }
                }
            });
        }

        // åˆå§‹åŒ–é é¢
        async function initializePage() {
            // ç­‰å¾…Firebaseåˆå§‹åŒ–
            setTimeout(async () => {
                updateFirebaseStatus("ğŸ”„ æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...", "loading");
                try {
                    await loadDataFromFirebase();
                    renderAdultList();
                    renderChildList();
                    updateStatistics();
                    
                    // å˜—è©¦è¨­ç½®å³æ™‚åŒæ­¥
                    try {
                        setupRealtimeSync();
                        updateFirebaseStatus("âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼Œé›²ç«¯åŒæ­¥å·²å•Ÿå‹•", "success");
                    } catch (syncError) {
                        updateFirebaseStatus("ğŸ“± ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜æ¨¡å¼", "warning");
                    }
                } catch (error) {
                    updateFirebaseStatus("ğŸ“± ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜æ¨¡å¼", "warning");
                }
            }, 1000);
        }

        // æ¸²æŸ“å¤§äººåå–®
        function renderAdultList() {
            const adultList = document.getElementById('adultList');
            adultList.innerHTML = '';
            
            people.adults.forEach((person, index) => {
                const personCard = document.createElement('div');
                personCard.className = `border-2 rounded-lg p-4 transition-all ${person.checkedIn ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-gray-50'}`;
                
                personCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-800">${person.name}</span>
                        <span class="text-sm ${person.checkedIn ? 'text-green-600' : 'text-gray-500'}">
                            ${person.checkedIn ? 'âœ… å·²ç°½åˆ°' : 'â³ æœªç°½åˆ°'}
                        </span>
                    </div>
                    <div class="bg-gray-100 rounded p-2 mb-2 text-center">
                        <span class="text-xs text-gray-500">å°ˆå±¬æ¢ç¢¼</span>
                        <div class="font-mono text-lg font-bold text-blue-600">${person.barcode}</div>
                    </div>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sm text-gray-600">ğŸµ é’èŒ¶: ${person.teaCount}/${person.maxTea}</span>
                        <button onclick="toggleCheckIn('adult', ${index})" 
                                class="px-3 py-1 rounded text-sm font-medium transition-colors ${person.checkedIn ? 'bg-gray-300 text-gray-600' : 'bg-blue-500 text-white hover:bg-blue-600'}">
                            ${person.checkedIn ? 'å–æ¶ˆç°½åˆ°' : 'ç°½åˆ°'}
                        </button>
                    </div>
                    <button onclick="redeemTea(${index})" 
                            class="w-full py-2 rounded font-medium transition-colors ${person.checkedIn && person.teaCount < person.maxTea ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}"
                            ${!person.checkedIn || person.teaCount >= person.maxTea ? 'disabled' : ''}>
                        ğŸµ é ˜å–é’èŒ¶ (éœ€åˆ·æµæ°´è™Ÿ)
                    </button>
                `;
                
                adultList.appendChild(personCard);
            });
        }

        // æ¸²æŸ“å°å­©åå–®
        function renderChildList() {
            const childList = document.getElementById('childList');
            childList.innerHTML = '';
            
            people.children.forEach((person, index) => {
                const personCard = document.createElement('div');
                personCard.className = `border-2 rounded-lg p-4 transition-all ${person.checkedIn ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-gray-50'}`;
                
                personCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-800">${person.name}</span>
                        <span class="text-sm ${person.checkedIn ? 'text-green-600' : 'text-gray-500'}">
                            ${person.checkedIn ? 'âœ… å·²ç°½åˆ°' : 'â³ æœªç°½åˆ°'}
                        </span>
                    </div>
                    <div class="bg-gray-100 rounded p-2 mb-2 text-center">
                        <span class="text-xs text-gray-500">å°ˆå±¬æ¢ç¢¼</span>
                        <div class="font-mono text-lg font-bold text-orange-600">${person.barcode}</div>
                    </div>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sm text-gray-600">ğŸª é¤…ä¹¾: ${person.cookieCount}/${person.maxCookie}</span>
                        <button onclick="toggleCheckIn('child', ${index})" 
                                class="px-3 py-1 rounded text-sm font-medium transition-colors ${person.checkedIn ? 'bg-gray-300 text-gray-600' : 'bg-blue-500 text-white hover:bg-blue-600'}">
                            ${person.checkedIn ? 'å–æ¶ˆç°½åˆ°' : 'ç°½åˆ°'}
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 mb-2">éœ€åˆ·æµæ°´è™Ÿç°½åˆ°ï¼Œå†åˆ·å•†å“æ¢ç¢¼2025-PROD-COOK-4515é ˜é¤…ä¹¾</div>
                `;
                
                childList.appendChild(personCard);
            });
        }

        // åˆ‡æ›ç°½åˆ°ç‹€æ…‹
        function toggleCheckIn(type, index) {
            if (type === 'adult') {
                people.adults[index].checkedIn = !people.adults[index].checkedIn;
                const personName = people.adults[index].name;
                const message = people.adults[index].checkedIn ? `${personName} å ±åˆ°æˆåŠŸ` : 'å–æ¶ˆç°½åˆ°';
                showNotification(message, 'success', people.adults[index].checkedIn);
            } else {
                people.children[index].checkedIn = !people.children[index].checkedIn;
                const personName = people.children[index].name;
                const message = people.children[index].checkedIn ? `${personName} å ±åˆ°æˆåŠŸ` : 'å–æ¶ˆç°½åˆ°';
                showNotification(message, 'success', people.children[index].checkedIn);
            }
            
            renderAdultList();
            renderChildList();
            updateStatistics();
            saveDataToFirebase(); // å„²å­˜åˆ°é›²ç«¯
        }

        // é ˜å–é’èŒ¶
        function redeemTea(index) {
            const person = people.adults[index];
            if (person.checkedIn && person.teaCount < person.maxTea) {
                person.teaCount++;
                showNotification(`${person.name} é ˜å–æˆåŠŸ`, 'success', true);
                renderAdultList();
                updateStatistics();
                saveDataToFirebase(); // å„²å­˜åˆ°é›²ç«¯
            }
        }

        // æƒæç‹€æ…‹ç®¡ç†
        let scanState = {
            waitingForProduct: false,
            selectedPerson: null,
            personType: null
        };

        // æ¢ç¢¼æƒæ
        function scanBarcode() {
            const barcodeInput = document.getElementById('barcodeInput');
            const barcode = barcodeInput.value.trim();
            
            if (!barcode) {
                showNotification('è«‹è¼¸å…¥æ¢ç¢¼ï¼', 'error');
                return;
            }
            
            // å¦‚æœæ­£åœ¨ç­‰å¾…å•†å“æ¢ç¢¼
            if (scanState.waitingForProduct) {
                handleProductBarcode(barcode);
                barcodeInput.value = '';
                return;
            }
            
            let found = false;
            
            // æª¢æŸ¥å¤§äººæ¢ç¢¼ (ç°½åˆ°ç”¨)
            people.adults.forEach((adult, index) => {
                if (adult.barcode === barcode) {
                    if (!adult.checkedIn) {
                        adult.checkedIn = true;
                        showNotification(`${adult.name} å ±åˆ°æˆåŠŸ`, 'success', true);
                        found = true;
                    } else {
                        // å·²ç°½åˆ°çš„å¤§äººå¯ä»¥ç›´æ¥é ˜é’èŒ¶
                        if (adult.teaCount < adult.maxTea) {
                            adult.teaCount++;
                            showNotification(`${adult.name} é ˜å–æˆåŠŸ`, 'success', true);
                        } else {
                            showNotification(`${adult.name} é’èŒ¶å·²é ˜å®Œï¼`, 'error');
                        }
                        found = true;
                    }
                }
            });
            
            // æª¢æŸ¥å°å­©æ¢ç¢¼ (ç°½åˆ°ç”¨)
            people.children.forEach((child, index) => {
                if (child.barcode === barcode) {
                    if (!child.checkedIn) {
                        child.checkedIn = true;
                        showNotification(`${child.name} å ±åˆ°æˆåŠŸ`, 'success', true);
                        found = true;
                    } else {
                        // å·²ç°½åˆ°çš„å°å­©éœ€è¦ç­‰å¾…å•†å“æ¢ç¢¼
                        scanState.waitingForProduct = true;
                        scanState.selectedPerson = child;
                        scanState.personType = 'child';
                        showNotification(`è«‹æƒæå•†å“æ¢ç¢¼ (2025-PROD-COOK-4515)`, 'success');
                        found = true;
                    }
                }
            });
            
            if (!found) {
                showNotification('æ¢ç¢¼ä¸å­˜åœ¨ï¼è«‹æª¢æŸ¥æ¢ç¢¼æ˜¯å¦æ­£ç¢º', 'error');
            } else {
                renderAdultList();
                renderChildList();
                updateStatistics();
                saveDataToFirebase(); // å„²å­˜åˆ°é›²ç«¯
            }
            
            barcodeInput.value = '';
        }

        // è™•ç†å•†å“æ¢ç¢¼
        function handleProductBarcode(barcode) {
            if (barcode === '2025-PROD-COOK-4515' && scanState.personType === 'child') {
                const child = scanState.selectedPerson;
                if (child.cookieCount < child.maxCookie) {
                    child.cookieCount++;
                    showNotification(`${child.name} é ˜å–æˆåŠŸ`, 'success', true);
                } else {
                    showNotification(`${child.name} é¤…ä¹¾å·²é ˜å®Œï¼`, 'error');
                }
            } else {
                showNotification('å•†å“æ¢ç¢¼éŒ¯èª¤ï¼', 'error');
            }
            
            // é‡ç½®æƒæç‹€æ…‹
            scanState.waitingForProduct = false;
            scanState.selectedPerson = null;
            scanState.personType = null;
            
            renderAdultList();
            renderChildList();
            updateStatistics();
            saveDataToFirebase();
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStatistics() {
            const checkedInAdults = people.adults.filter(p => p.checkedIn).length;
            const checkedInChildren = people.children.filter(p => p.checkedIn).length;
            const totalCheckedIn = checkedInAdults + checkedInChildren;
            
            const totalTea = people.adults.reduce((sum, p) => sum + p.teaCount, 0);
            const totalCookies = people.children.reduce((sum, p) => sum + p.cookieCount, 0);
            
            document.getElementById('checkedInCount').textContent = totalCheckedIn;
            document.getElementById('teaRedeemed').textContent = totalTea;
            document.getElementById('cookieRedeemed').textContent = totalCookies;
        }

        // TTSèªéŸ³æ’­å ±
        function speakMessage(message) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                utterance.pitch = 1.2;
                utterance.volume = 1;
                
                // é¸æ“‡ä¸åŒçš„èªéŸ³
                const voices = speechSynthesis.getVoices();
                const femaleVoice = voices.find(voice => 
                    voice.lang.includes('zh') && voice.name.includes('Female')
                ) || voices.find(voice => 
                    voice.lang.includes('zh') && voice.name.includes('å¥³')
                ) || voices.find(voice => voice.lang.includes('zh'));
                
                if (femaleVoice) {
                    utterance.voice = femaleVoice;
                }
                
                speechSynthesis.speak(utterance);
            }
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success', speak = false) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            } text-white`;
            
            // é¡¯ç¤ºé€šçŸ¥
            notification.style.transform = 'translateX(0)';
            
            // TTSæ’­å ±
            if (speak) {
                speakMessage(message);
            }
            
            // 3ç§’å¾Œéš±è—
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
            }, 3000);
        }

        // æ¢ç¢¼è¼¸å…¥æ¡†æŒ‰Enteréµè§¸ç™¼æƒæ
        document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                scanBarcode();
            }
        });

        // åˆå§‹åŒ–é é¢
        initializePage();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'989902a1656e8098',t:'MTc1OTYyNjMyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
